<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>RNA-FM-LCX Prediction</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #8c37ce, #5b3db4);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      display: none;
      z-index: 9999;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .modal-content {
      background: #2e2e2e;
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      color: white;
      max-width: 300px;
    }
    .custom-select { position: relative; user-select: none; }
    .select-selected {
      background-color: #2a2a2a; border: 1px solid #555; padding: 12px; border-radius: 8px; cursor: pointer; position: relative;
    }
    .select-selected::after {
      content: "â–¼";
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 12px;
      color: white;
    }
    .select-items {
      position: absolute; background-color: #2a2a2a;
      top: 50px; left: 0; right: 0;
      border-radius: 8px; overflow: hidden;
      border: 1px solid #555; z-index: 99;
    }
    .select-item { padding: 12px; cursor: pointer; transition: all 0.3s; color: white; }
    .select-item:hover { background: linear-gradient(to right, #8c37ce, #5b3db4); }
  </style>
</head>

<body class="bg-[#0f0f0f] text-white font-sans min-h-screen flex flex-col">

<nav class="bg-[#1a1a1a] shadow-lg">
  <div class="container mx-auto px-6 py-4 flex justify-between items-center">
    <div class="text-2xl font-bold">CRISPR-FMC Dashboard</div>
    <div class="text-sm opacity-70">Predict CRISPR Efficiency</div>
  </div>
</nav>

<main class="flex-1 container mx-auto px-6 py-10 flex flex-wrap gap-8">

  <div class="flex-1 min-w-[60%]">

    <section class="bg-[#1e1e1e] rounded-2xl p-8 shadow-md mb-8">
      <h2 class="text-2xl font-semibold mb-6">Input Settings</h2>

      <label class="block text-sm mb-2">Select Database</label>
      <div class="w-full mb-6 custom-select">
        <div id="selectedDatabase" onclick="toggleDropdown()" class="select-selected">Select Database</div>
        <div id="selectOptions" class="select-items hidden">
          <div class="select-item" onclick="chooseOption('WT')">WT</div>
          <div class="select-item" onclick="chooseOption('ESP')">ESP</div>
          <div class="select-item" onclick="chooseOption('HF')">HF</div>
        </div>
      </div>

      <label for="sequence" class="block text-sm mb-2">Input Sequence</label>
      <div class="mb-6 relative">
        <input type="text" id="sequence" class="w-full rounded-lg p-3 pr-12 bg-[#2a2a2a] border border-gray-700 focus:ring-2 focus:ring-purple-500" placeholder="Enter 23bp sgRNA sequence">
        <button onclick="clearInput()" class="absolute right-3 top-1/2 transform -translate-y-1/2">
          <svg class="h-5 w-5 text-gray-400 hover:text-white" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
            <path d="M512 883.2A371.2 371.2 0 1 0 140.8 512 371.2 371.2 0 0 0 512 883.2z m0 64a435.2 435.2 0 1 1 435.2-435.2 435.2 435.2 0 0 1-435.2 435.2z" fill="#5A5A68"></path>
            <path d="M557.056 512l122.368 122.368a31.744 31.744 0 1 1-45.056 45.056L512 557.056l-122.368 122.368a31.744 31.744 0 1 1-45.056-45.056L466.944 512 344.576 389.632a31.744 31.744 0 1 1 45.056-45.056L512 466.944l122.368-122.368a31.744 31.744 0 1 1 45.056 45.056z" fill="#5A5A68"></path>
          </svg>
        </button>
      </div>

      <div class="flex gap-4">
        <button onclick="submitData()" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-500 hover:opacity-90 py-3 rounded-xl font-bold text-lg">Predict</button>
        <button onclick="clearTable()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-700 hover:opacity-90 py-3 rounded-xl font-bold text-lg">Clear History</button>
      </div>

      <div id="loading" class="hidden mt-6 flex justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-purple-500"></div>
      </div>
    </section>

    <section class="bg-[#1e1e1e] rounded-2xl p-8 shadow-md">
      <h2 class="text-2xl font-semibold mb-6">Prediction Output</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-center">
          <thead class="bg-[#2a2a2a] text-gray-400 uppercase">
            <tr>
              <th class="px-6 py-3">Database</th>
              <th class="px-6 py-3">Sequence</th>
              <th class="px-6 py-3">Prediction Score</th>
            </tr>
          </thead>
          <tbody id="resultTable" class="text-gray-200"></tbody>
        </table>
      </div>
    </section>

  </div>
  <div class="flex-1 min-w-[30%] bg-[#1e1e1e] rounded-2xl p-8 shadow-md flex flex-col">
    <h2 class="text-2xl font-semibold mb-6">Average Efficiency</h2>
    <canvas id="efficiencyChart" class="mt-4"></canvas>
  </div>

</main>

<div id="notification" class="notification"></div>
<div id="errorModal" class="modal">
  <div class="modal-content">
    <p id="errorText" class="mb-4"></p>
    <button onclick="closeError()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-full font-bold">OK</button>
  </div>
</div>

<script>
let currentDatabase = "";
let efficiencyStats = { WT: {sum:0, count:0}, ESP: {sum:0, count:0}, HF: {sum:0, count:0} };

const ctx = document.getElementById('efficiencyChart').getContext('2d');
const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
gradient1.addColorStop(0, '#00c6ff');
gradient1.addColorStop(1, '#0072ff');

const efficiencyChart = new Chart(ctx, {
  type: 'radar',
  data: {
    labels: ['WT', 'ESP', 'HF'],
    datasets: [{
      label: 'Average Efficiency',
      data: [0, 0, 0],
      backgroundColor: gradient1,
      borderColor: '#8c37ce',
      borderWidth: 2,
      pointBackgroundColor: '#ffffff',
      pointBorderColor: '#8c37ce',
      pointHoverBackgroundColor: '#8c37ce',
      pointHoverBorderColor: '#ffffff',
      fill: true,
      tension: 0.4,
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + (context.raw).toFixed(3);
          }
        }
      },
      datalabels: {
        color: '#ffffff',
        formatter: (value) => value.toFixed(3),
        font: { weight: 'bold', size: 14 },
        anchor: 'end',
        align: 'top'
      }
    },
    scales: {
      r: {
        angleLines: { color: '#444' },
        grid: { color: '#333' },
        pointLabels: { color: 'white', font: { size: 14 } },
        ticks: { color: 'white', backdropColor: 'transparent' },
        min: 0,
        max: 1,
        stepSize: 0.2
      }
    },
    animation: {
      duration: 1500,
      easing: 'easeOutBounce'
    }
  },
  plugins: [ChartDataLabels]
});

function toggleDropdown() {
  document.getElementById('selectOptions').classList.toggle('hidden');
}
function chooseOption(value) {
  document.getElementById('selectedDatabase').innerText = value;
  currentDatabase = value;
  document.getElementById('selectOptions').classList.add('hidden');
}
window.onclick = function(e) {
  if (!e.target.closest('.custom-select')) {
    document.getElementById('selectOptions').classList.add('hidden');
  }
}

function submitData() {
  const sequence = document.getElementById('sequence').value.trim().toUpperCase();
  if (currentDatabase === "") { showError("Please select a database first!"); return; }
  if (sequence.length !== 23) { showError("Sequence must be exactly 23 bases long!"); return; }
  if (!sequence.endsWith("GG")) { showError("Sequence must end with 'GG'!"); return; }

  document.getElementById('loading').classList.remove('hidden');

  axios.post('http://127.0.0.1:12345/predictxx', { database: currentDatabase, sequence })
    .then(response => {
      const prediction = response.data.prediction;
      const table = document.getElementById('resultTable');
      const newRow = table.insertRow();
      newRow.className = 'hover:bg-[#2e2e2e] transition-all';
      const cell1 = newRow.insertCell(0);
      const cell2 = newRow.insertCell(1);
      const cell3 = newRow.insertCell(2);

      cell1.innerText = currentDatabase;
      cell2.innerText = sequence;
      cell3.innerText = prediction.toFixed(4);

      efficiencyStats[currentDatabase].sum += prediction;
      efficiencyStats[currentDatabase].count += 1;
      updateChart();

      showNotification("Prediction Successful!");
    })
    .catch(error => {
      showError("Prediction failed. Try again.");
    })
    .finally(() => {
      document.getElementById('loading').classList.add('hidden');
    });
}

function updateChart() {
  efficiencyChart.data.datasets[0].data = [
    efficiencyStats.WT.count ? (efficiencyStats.WT.sum / efficiencyStats.WT.count) : 0,
    efficiencyStats.ESP.count ? (efficiencyStats.ESP.sum / efficiencyStats.ESP.count) : 0,
    efficiencyStats.HF.count ? (efficiencyStats.HF.sum / efficiencyStats.HF.count) : 0
  ];
  efficiencyChart.update();
}

function showNotification(text) {
  const notification = document.getElementById('notification');
  notification.innerText = text;
  notification.style.display = 'block';
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

function showError(message) {
  document.getElementById('errorText').innerText = message;
  document.getElementById('errorModal').style.display = 'flex';
}

function closeError() {
  document.getElementById('errorModal').style.display = 'none';
}

function clearTable() {
  document.getElementById('resultTable').innerHTML = '';
}

function clearInput() {
  document.getElementById('sequence').value = '';
}
</script>

</body>
</html>
